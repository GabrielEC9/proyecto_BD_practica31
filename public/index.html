<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Taller Automotriz Interactivo</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body { background: #f4f6f9; font-family: 'Segoe UI', sans-serif; padding: 20px; }
  h1 { text-align: center; margin-bottom: 30px; color: #222; font-weight: bold; }
  .menu { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
  .card { margin-bottom: 20px; transition: transform 0.2s; }
  .card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
  .vehiculos { margin-top: 10px; padding-left: 15px; }
  .orden { padding: 15px; margin-bottom: 12px; border-radius: 10px; background: #fff; box-shadow: 0 3px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
  .orden:hover { transform: scale(1.02); }
  .prioritaria { border-left: 6px solid #FF4136; }
  .no-prioritaria { border-left: 6px solid #007BFF; }
  .tablero { display: flex; gap: 20px; flex-wrap: wrap; }
  .columna { flex: 1; min-width: 280px; }
  .accordion-button { cursor: pointer; }
  .no-vehiculos { font-style: italic; color: #777; }
  .logout-btn { position: absolute; top: 20px; right: 20px; }
</style>
</head>
<body>

<!-- üîê Bot√≥n de cerrar sesi√≥n -->
<button class="btn btn-danger logout-btn" onclick="cerrarSesion()"><i class="fas fa-sign-out-alt"></i> Cerrar sesi√≥n</button>

<h1><i class="fas fa-tools"></i> Taller Automotriz Interactivo</h1>

<div class="menu">
  <button class="btn btn-primary" onclick="mostrarSeccion('clientes')"><i class="fas fa-users"></i> Clientes</button>
  <button class="btn btn-secondary" onclick="mostrarSeccion('ordenes')"><i class="fas fa-clipboard-list"></i> √ìrdenes de Trabajo</button>
  <button class="btn btn-success" onclick="mostrarSeccion('nueva-orden')"><i class="fas fa-plus-circle"></i> Nueva Orden</button>
</div>

<div class="container">

  <!-- Clientes -->
  <div id="clientes-section">
    <h2>Clientes y Veh√≠culos</h2>
    <div id="clientes-container" class="row"></div>
  </div>

  <!-- √ìrdenes -->
  <div id="ordenes-section" style="display:none;">
    <h2>√ìrdenes de Trabajo</h2>
    <div class="tablero">
      <div class="columna">
        <h5>Pendientes</h5>
        <div id="pendientes"></div>
      </div>
      <div class="columna">
        <h5>En Progreso</h5>
        <div id="en-progreso"></div>
      </div>
      <div class="columna">
        <h5>Completadas</h5>
        <div id="completadas"></div>
      </div>
    </div>
  </div>

  <!-- Nueva Orden -->
  <div id="nueva-orden-section" style="display:none;">
    <h2>Registrar Nueva Orden de Trabajo</h2>
    <form id="form-orden" class="p-3 bg-white shadow rounded">
      <div class="mb-3">
        <label class="form-label">Cliente</label>
        <select id="cliente-select" class="form-select" required></select>
      </div>
      <div class="mb-3">
        <label class="form-label">Veh√≠culo</label>
        <select id="vehiculo-select" class="form-select" required></select>
      </div>
      <div class="mb-3">
        <label class="form-label">Servicio</label>
        <select id="servicio-select" class="form-select" required></select>
      </div>
      <div class="mb-3">
        <label class="form-label">Prioridad</label>
        <select id="prioridad" class="form-select" required>
          <option value="Alta">Alta</option>
          <option value="Normal">Normal</option>
        </select>
      </div>
      <div class="mb-3">
        <label class="form-label">Fecha de ingreso</label>
        <input type="date" id="fecha_ingreso" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Fecha de salida</label>
        <input type="date" id="fecha_salida" class="form-control" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Costo</label>
        <input type="number" id="costo" class="form-control" readonly>
      </div>
      <button type="submit" class="btn btn-success w-100"><i class="fas fa-save"></i> Guardar Orden</button>
    </form>
    <div id="mensaje-orden" class="mt-3"></div>
  </div>

</div>

<script>
const SUPABASE_URL = "https://lvuqrksujmgwgvebokgw.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx2dXFya3N1am1nd2d2ZWJva2d3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAxNzA0NzIsImV4cCI6MjA3NTc0NjQ3Mn0.-r4fp5yQi1pH2qHmbEbhm-6Q_4WgXc_yrr3JQZpGJV4";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// üîê Verificar sesi√≥n
async function verificarSesion() {
  const { data } = await supabase.auth.getSession();
  if (!data.session) window.location.href = "login.html";
}
verificarSesion();

// üîí Cerrar sesi√≥n
async function cerrarSesion() {
  await supabase.auth.signOut();
  window.location.href = "login.html";
}

// üñ•Ô∏è Navegaci√≥n de secciones
function mostrarSeccion(seccion) {
  ['clientes','ordenes','nueva-orden'].forEach(s => {
    document.getElementById(`${s}-section`).style.display = s===seccion ? 'block':'none';
  });
}

// üßæ Cargar clientes en secci√≥n y en formulario
async function cargarClientes() {
  const { data, error } = await supabase.from("cliente").select("id_cliente, nombre, apellido, telefono, direccion, vehiculo(id_vehiculo, marca, modelo, matricula)");
  if (error) return console.error(error);

  // Clientes secci√≥n
  const contenedor = document.getElementById("clientes-container");
  contenedor.innerHTML = "";
  data.forEach(c => {
    const card = document.createElement("div");
    card.className = "col-md-4";
    card.innerHTML = `
      <div class="card p-3">
        <h5><i class="fas fa-user"></i> ${c.nombre} ${c.apellido || ""}</h5>
        <p><i class="fas fa-phone"></i> ${c.telefono}</p>
        <p><i class="fas fa-map-marker-alt"></i> ${c.direccion}</p>
        <button class="btn btn-sm btn-outline-primary toggle-veh"><i class="fas fa-car"></i> Ver Veh√≠culos</button>
        <div class="vehiculos mt-2" style="display:none;">
          ${c.vehiculo?.length
            ? c.vehiculo.map(v => `<div><i class="fas fa-car-side"></i> ${v.marca} ${v.modelo} (${v.matricula})</div>`).join("")
            : "<div class='no-vehiculos'>No tiene veh√≠culos</div>"}
        </div>
      </div>`;
    const btn = card.querySelector(".toggle-veh");
    const vehDiv = card.querySelector(".vehiculos");
    btn.addEventListener("click", ()=>{ vehDiv.style.display = vehDiv.style.display==="none"?"block":"none"; });
    contenedor.appendChild(card);
  });

  // Clientes en formulario
  const clienteSelect = document.getElementById("cliente-select");
  clienteSelect.innerHTML = `<option value="">Seleccione un cliente</option>`;
  data.forEach(c => {
    clienteSelect.innerHTML += `<option value="${c.id_cliente}">${c.nombre} ${c.apellido}</option>`;
  });
}

// üöó Cargar veh√≠culos de un cliente en formulario
async function cargarVehiculosPorCliente(id_cliente) {
  const { data, error } = await supabase.from("vehiculo").select("*").eq("id_cliente", id_cliente);
  const vehiculoSelect = document.getElementById("vehiculo-select");
  vehiculoSelect.innerHTML = `<option value="">Seleccione un veh√≠culo</option>`;
  if (!error && data) {
    data.forEach(v => {
      vehiculoSelect.innerHTML += `<option value="${v.id_vehiculo}">${v.marca} ${v.modelo} (${v.matricula})</option>`;
    });
  }
}

// üõ†Ô∏è Cargar servicios en formulario
async function cargarServicios() {
  const { data } = await supabase.from("servicio").select("*");
  const servicioSelect = document.getElementById("servicio-select");
  servicioSelect.innerHTML = `<option value="">Seleccione un servicio</option>`;
  data.forEach(s => {
    servicioSelect.innerHTML += `<option value="${s.id_servicio}" data-costo="${s.costo}">${s.descripcion} ($${s.costo})</option>`;
  });
}

// üí∞ Actualizar costo al cambiar servicio
document.getElementById("servicio-select").addEventListener("change", e=>{
  const selected = e.target.selectedOptions[0];
  const costo = selected ? selected.dataset.costo : 0;
  document.getElementById("costo").value = costo;
});

// üìù Guardar nueva orden
document.getElementById("form-orden").addEventListener("submit", async (e)=>{
  e.preventDefault();
  const orden = {
    id_cliente: +document.getElementById("cliente-select").value,
    id_vehiculo: +document.getElementById("vehiculo-select").value,
    id_servicio: +document.getElementById("servicio-select").value,
    prioridad: document.getElementById("prioridad").value,
    fecha_ingreso: document.getElementById("fecha_ingreso").value,
    fecha_salida: document.getElementById("fecha_salida").value,
    costo: +document.getElementById("costo").value
  };
  const { error } = await supabase.from("orden_trabajo").insert([orden]);
  const msg = document.getElementById("mensaje-orden");
  if(error) msg.innerHTML = `<p class="text-danger">Error: ${error.message}</p>`;
  else {
    msg.innerHTML = `<p class="text-success">Orden agregada exitosamente.</p>`;
    e.target.reset();
    document.getElementById("vehiculo-select").innerHTML = "";
    document.getElementById("costo").value = "";
    cargarOrdenes();
  }
});

// üìù Cargar √≥rdenes existentes
async function cargarOrdenes() {
  const { data } = await supabase.from("orden_trabajo")
    .select("id_orden, fecha_ingreso, fecha_salida, prioridad, costo, vehiculo(id_vehiculo, marca, modelo), cliente(id_cliente, nombre, apellido), servicio(descripcion, costo), estado_pago");
  
  const pendientes = document.getElementById("pendientes");
  const enProgreso = document.getElementById("en-progreso");
  const completadas = document.getElementById("completadas");
  pendientes.innerHTML = enProgreso.innerHTML = completadas.innerHTML = "";

  data.forEach(o=>{
    const div = document.createElement("div");
    div.className = `orden ${o.prioridad==="Alta"?"prioritaria":"no-prioritaria"}`;
    div.innerHTML = `
      <strong>ID: ${o.id_orden}</strong><br>
      <i class="fas fa-user"></i> ${o.cliente?.nombre || "-"} ${o.cliente?.apellido || ""}<br>
      <i class="fas fa-car"></i> ${o.vehiculo?.marca} ${o.vehiculo?.modelo}<br>
      <i class="fas fa-wrench"></i> ${o.servicio?.descripcion} ($${o.costo})<br>
      <i class="fas fa-clock"></i> ${o.fecha_ingreso} ‚Üí ${o.fecha_salida}<br>
      <i class="fas fa-money-bill"></i> $${o.costo}<br>
      Prioridad: ${o.prioridad}`;
    
    if(o.estado_pago==="Pendiente") pendientes.appendChild(div);
    else if(o.estado_pago==="En progreso") enProgreso.appendChild(div);
    else completadas.appendChild(div);
  });
}

// üîÑ Eventos dependientes
document.getElementById("cliente-select").addEventListener("change", e=>{
  cargarVehiculosPorCliente(+e.target.value);
});

// üîÑ Inicializar p√°gina
cargarClientes();
cargarServicios();
cargarOrdenes();

</script>
</body>
</html>
